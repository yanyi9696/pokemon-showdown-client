{"version":3,"file":"battle-sound.js","names":["BattleBGM","url","loopstart","loopend","sound","timer","undefined","isPlaying","isActuallyPlaying","willRewind","_proto","prototype","play","resume","actuallyResume","pause","actuallyPause","update","stop","destroy","BattleSound","deleteBgm","currentBgm","getSound","currentTime","volume","bgmVolume","updateTime","_this","clearTimeout","progress","setTimeout","Math","max","current","_i2","_BattleSound$bgm2","bgm","length","_class2","soundCache","effectVolume","muted","_proto2","window","HTMLAudioElement","document","createElement","src","Config","routes","client","_unused","playEffect","playSound","effect","loadBgm","replaceBGM","push","soundIndex","indexOf","splice","_i4","_this$bgm2","setMute","loudnessPercentToAmplitudePercent","loudnessPercent","decibels","log","pow","setBgmVolume","setEffectVolume","PS","prefs","subscribeAndRun","key","effectvolume","musicvolume","mute"],"sources":["../src/battle-sound.ts"],"sourcesContent":["\nexport class BattleBGM {\n\t/**\n\t * May be shared with other BGM objects: every battle has its own BattleBGM\n\t * object, but two battles with the same music will have the same HTMLAudioElement\n\t * object.\n\t */\n\tsound?: HTMLAudioElement;\n\turl: string;\n\ttimer: number | undefined = undefined;\n\tloopstart: number;\n\tloopend: number;\n\t/**\n\t * When multiple battles with BGM are open, they will be `isPlaying`, but only the\n\t * first one will be `isActuallyPlaying`. In addition, muting volume or setting\n\t * BGM volume to 0 will set `isActuallyPlaying` to false.\n\t */\n\tisPlaying = false;\n\tisActuallyPlaying = false;\n\t/**\n\t * The sound should be rewound when it next plays.\n\t */\n\twillRewind = true;\n\tconstructor(url: string, loopstart: number, loopend: number) {\n\t\tthis.url = url;\n\t\tthis.loopstart = loopstart;\n\t\tthis.loopend = loopend;\n\t}\n\tplay() {\n\t\tthis.willRewind = true;\n\t\tthis.resume();\n\t}\n\tresume() {\n\t\tthis.isPlaying = true;\n\t\tthis.actuallyResume();\n\t}\n\tpause() {\n\t\tthis.isPlaying = false;\n\t\tthis.actuallyPause();\n\t\tBattleBGM.update();\n\t}\n\tstop() {\n\t\tthis.pause();\n\t\tthis.willRewind = true;\n\t}\n\tdestroy() {\n\t\tBattleSound.deleteBgm(this);\n\t\tthis.pause();\n\t}\n\n\tactuallyResume() {\n\t\tif (this !== BattleSound.currentBgm()) return;\n\t\tif (this.isActuallyPlaying) return;\n\n\t\tif (!this.sound) this.sound = BattleSound.getSound(this.url);\n\t\tif (!this.sound) return;\n\t\tif (this.willRewind) this.sound.currentTime = 0;\n\t\tthis.willRewind = false;\n\t\tthis.isActuallyPlaying = true;\n\t\tthis.sound.volume = BattleSound.bgmVolume / 100;\n\t\tthis.sound.play();\n\t\tthis.updateTime();\n\t}\n\tactuallyPause() {\n\t\tif (!this.isActuallyPlaying) return;\n\t\tthis.isActuallyPlaying = false;\n\t\tthis.sound!.pause();\n\t\tthis.updateTime();\n\t}\n\t/**\n\t * Handles the hard part of looping the sound\n\t */\n\tupdateTime() {\n\t\tclearTimeout(this.timer);\n\t\tthis.timer = undefined;\n\t\tif (this !== BattleSound.currentBgm()) return;\n\t\tif (!this.sound) return;\n\n\t\tconst progress = this.sound.currentTime * 1000;\n\t\tif (progress > this.loopend - 1000) {\n\t\t\tthis.sound.currentTime -= (this.loopend - this.loopstart) / 1000;\n\t\t}\n\n\t\tthis.timer = setTimeout(() => {\n\t\t\tthis.updateTime();\n\t\t}, Math.max(this.loopend - progress, 1));\n\t}\n\n\tstatic update() {\n\t\tconst current = BattleSound.currentBgm();\n\t\tfor (const bgm of BattleSound.bgm) {\n\t\t\tif (bgm.isPlaying) {\n\t\t\t\tif (bgm === current) {\n\t\t\t\t\tbgm.actuallyResume();\n\t\t\t\t} else {\n\t\t\t\t\tbgm.actuallyPause();\n\t\t\t\t}\n\t\t\t}\n\t\t}\n\t}\n}\n\nexport const BattleSound = new class {\n\tsoundCache: {[url: string]: HTMLAudioElement | undefined} = {};\n\n\tbgm: BattleBGM[] = [];\n\n\t// options\n\teffectVolume = 50;\n\tbgmVolume = 50;\n\tmuted = false;\n\n\tgetSound(url: string) {\n\t\tif (!window.HTMLAudioElement) return;\n\t\tif (this.soundCache[url]) return this.soundCache[url];\n\t\ttry {\n\t\t\tconst sound = document.createElement('audio');\n\t\t\tsound.src = 'https://' + Config.routes.client + '/' + url;\n\t\t\tsound.volume = this.effectVolume / 100;\n\t\t\tthis.soundCache[url] = sound;\n\t\t\treturn sound;\n\t\t} catch {}\n\t}\n\n\tplayEffect(url: string) {\n\t\tthis.playSound(url, this.muted ? 0 : this.effectVolume);\n\t}\n\n\tplaySound(url: string, volume: number) {\n\t\tif (!volume) return;\n\t\tconst effect = this.getSound(url);\n\t\tif (effect) {\n\t\t\teffect.volume = volume / 100;\n\t\t\teffect.play();\n\t\t}\n\t}\n\n\t/** loopstart and loopend are in milliseconds */\n\tloadBgm(url: string, loopstart: number, loopend: number, replaceBGM?: BattleBGM | null) {\n\t\tif (replaceBGM) {\n\t\t\treplaceBGM.stop();\n\t\t\tthis.deleteBgm(replaceBGM);\n\t\t}\n\n\t\tconst bgm = new BattleBGM(url, loopstart, loopend);\n\t\tthis.bgm.push(bgm);\n\t\treturn bgm;\n\t}\n\tdeleteBgm(bgm: BattleBGM) {\n\t\tconst soundIndex = BattleSound.bgm.indexOf(bgm);\n\t\tif (soundIndex >= 0) BattleSound.bgm.splice(soundIndex, 1);\n\t}\n\n\tcurrentBgm() {\n\t\tif (!this.bgmVolume || this.muted) return false;\n\t\tfor (const bgm of this.bgm) {\n\t\t\tif (bgm.isPlaying) return bgm;\n\t\t}\n\t\treturn null;\n\t}\n\n\t// setting\n\tsetMute(muted: boolean) {\n\t\tmuted = !!muted;\n\t\tif (this.muted === muted) return;\n\t\tthis.muted = muted;\n\t\tBattleBGM.update();\n\t}\n\n\tloudnessPercentToAmplitudePercent(loudnessPercent: number) {\n\t\t// 10 dB is perceived as approximately twice as loud\n\t\tlet decibels = 10 * Math.log(loudnessPercent / 100) / Math.log(2);\n\t\treturn Math.pow(10, decibels / 20) * 100;\n\t}\n\tsetBgmVolume(bgmVolume: number) {\n\t\tthis.bgmVolume = this.loudnessPercentToAmplitudePercent(bgmVolume);\n\t\tBattleBGM.update();\n\t}\n\tsetEffectVolume(effectVolume: number) {\n\t\tthis.effectVolume = this.loudnessPercentToAmplitudePercent(effectVolume);\n\t}\n};\n\nif (typeof PS === 'object') {\n\tPS.prefs.subscribeAndRun(key => {\n\t\tif (!key || key === 'musicvolume' || key === 'effectvolume' || key === 'mute') {\n\t\t\tBattleSound.effectVolume = PS.prefs.effectvolume;\n\t\t\tBattleSound.bgmVolume = PS.prefs.musicvolume;\n\t\t\tBattleSound.muted = PS.prefs.mute;\n\t\t\tBattleBGM.update();\n\t\t}\n\t});\n}\n"],"mappings":"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"}